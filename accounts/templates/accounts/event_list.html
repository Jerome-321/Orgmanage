{% extends 'accounts/base.html' %}
{% load static %}
{% block title %}Events{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  
  <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">Events</h1>
  <p class="text-gray-500 mb-6">register for upcoming events</p>
  
  <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
    <div class="flex items-center flex-wrap gap-3">
    
      <div class="flex gap-3 mb-6">
        <a href="?filter=all"
          class="px-4 py-2 rounded-md text-sm font-medium
          {% if active_filter == 'all' %} 
            bg-blue-600 text-white
          {% else %} 
          bg-gray-100 text-gray-700 hover:bg-gray-200
          {% endif %}">All Events
        </a>
      
        <a href="?filter=upcoming"
            class="px-4 py-2 rounded-md text-sm font-medium
            {% if active_filter == 'upcoming' %}
              bg-blue-600 text-white
            {% else %}
            bg-gray-100 text-gray-700 hover:bg-gray-200
            {% endif %}">Upcoming
        </a>

        <a href="?filter=completed"
            class="px-4 py-2 rounded-md text-sm font-medium
            {% if active_filter == 'completed' %}
              bg-blue-600 text-white
            {% else %} 
            bg-gray-100 text-gray-700 hover:bg-gray-200
            {% endif %}">Completed
        </a>
    </div>
    
    <div class="flex-1"></div>

    
    {% if user.member.role in "admin superadmin" %}
    <button onclick="openModal('modalCreate')" 
      class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-md text-sm shadow">
      + Create Event
    </button>
    {% endif %}
  </div>
</div>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for event in events %}
    <div class="bg-white rounded-lg shadow p-4 flex flex-col justify-between">
      <div>
        <div class="flex justify-between items-start mb-2">
          <h3 class="text-lg font-semibold">{{ event.title }}</h3>
          {% if event.start_datetime > now %}
          <span class="text-green-700 bg-green-50 px-2 py-1 rounded-full text-xs">Upcoming</span>
          {% else %}
          <span class="text-gray-600 bg-gray-100 px-2 py-1 rounded-full text-xs">Completed</span>
          {% endif %}
        </div>
        <p class="text-gray-700 line-clamp-3 mb-3">{{ event.description }}</p>
        <div class="text-sm text-gray-500 space-y-1">
          <div>📅 {{ event.start_datetime|date:"M d, Y H:i" }} </div>
          <div>📍 {{ event.location }}</div>
          <div><strong>Slots:</strong> {{ event.slots_remaining }}</div>
        </div>
      </div>
      
      <div class="mt-4 flex flex-wrap gap-2">
        <button onclick="openModal('modalView{{ event.id }}')" 
           class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 modal-open">View</button>

        {% if user.member.role in "admin superadmin" %}
        <a href="{% url 'accounts:attendance_report' event.id %}">
          <button class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Report</button>
        </a>
        
        
        {% else %}
        {% if event.registered %}
        <button onclick="openModal('modalCancel{{ event.id }}')" 
          class="bg-red-500 hover:bg-red-700 text-white px-3 py-2 rounded text-sm">Cancel</button>
        {% elif event.slots_remaining > 0 %}
        <button onclick="openModal('modalRegister{{ event.id }}')" 
          class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm">Register</button>
        {% endif %}
        {% endif %}
        {% if event.registered %}
      <a href="{% url 'accounts:view_qr' event.id %}" 
     class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
     View QR
  </a>
{% endif %}
      </div>
    </div>

<div id="modalView{{ event.id }}" tabindex="-1" aria-hidden="true"
  class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
  <div class="relative w-full max-w-lg p-6">
    <div class="relative bg-white rounded-2xl shadow-2xl overflow-hidden">
      
      <div class="flex justify-between items-start border-b border-gray-200 p-6">
        <div>
          <h3 class="text-2xl font-semibold text-gray-800">{{ event.title }}</h3>
          {% if event.start_datetime > now %}
          <span class="inline-block mt-2 px-3 py-1 text-xs font-medium bg-green-100 text-green-700 rounded-full">
            Upcoming
          </span>
          {% else %}
          <span class="inline-block mt-2 px-3 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">
            Completed
          </span>
          {% endif %}
        </div>
        <button type="button" onclick="closeModal('modalView{{ event.id }}')" 
          class="text-gray-400 hover:text-gray-600 transition">
          ✖
        </button>
      </div>

      
      <div class="p-6 space-y-4 text-gray-700">
        
        <div class="flex items-center gap-3">
          <div class="bg-blue-100 text-blue-600 p-2 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z" />
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-500">Date & Time</p>
            <p class="font-medium">{{ event.start_datetime|date:"M d, Y H:i" }} - {{ event.end_datetime|date:"M d, Y H:i" }}</p>
          </div>
        </div>

        
        <div class="flex items-center gap-3">
          <div class="bg-purple-100 text-purple-600 p-2 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M12 21c4.418 0 8-3.582 8-8S16.418 5 12 5 4 8.582 4 13s3.582 8 8 8z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v4l2 2" />
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-500">Location</p>
            <p class="font-medium">{{ event.location }}</p>
          </div>
        </div>

        
        <div class="flex justify-between text-sm text-gray-600 mt-4 border-t border-gray-100 pt-4">
          <div><strong>Registered:</strong> {{ event.total_registered }} / {{ event.capacity }}</div>
          <div><strong>Remaining:</strong> {{ event.slots_remaining }}</div>
        </div>

        
        <div class="mt-4">
          <h4 class="text-sm font-semibold text-gray-800 mb-1">Description</h4>
          <p class="text-gray-600 leading-relaxed">{{ event.description }}</p>
        </div>
      </div>

      
      <div class="flex justify-end gap-3 p-6 border-t border-gray-100 bg-gray-50">
        {% if user.member.role in "admin superadmin" %}
          <button onclick="openModal('modalEdit{{ event.id }}')" 
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm">Edit</button>
          <button onclick="openModal('modalDelete{{ event.id }}')" 
            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm">Delete</button>
          <a href="{% url 'accounts:scan_qr_page' %}">
        <button class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Scan QR Code</button>
          </a>
        {% else %}
          {% if event.start_datetime > now %}
            {% if event.registered %}
              <button onclick="openModal('modalCancel{{ event.id }}')" 
                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm">Cancel Registration</button>
            {% elif event.slots_remaining > 0 %}
              <button onclick="openModal('modalRegister{{ event.id }}')" 
                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm">Register Now</button>
            {% endif %}
          {% endif %}
      <a href="{% url 'accounts:view_qr' event.id %}" 
     class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-md text-sm">
     View QR
  </a>
        {% endif %}
        <button onclick="closeModal('modalView{{ event.id }}')" 
          class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-md text-sm">Close</button>
      </div>
      
    </div>
  </div>
</div>

    {% if user.member.role in "admin superadmin" %}
    
<div id="modalEdit{{ event.id }}" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 relative">

    
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-2xl font-semibold text-gray-800 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17h2m-1-12a9 9 0 110 18 9 9 0 010-18z" />
        </svg>
        Edit Event
      </h3>
      <button type="button" onclick="closeModal('modalEdit{{ event.id }}')" class="text-gray-500 hover:text-gray-700">
        ✕
      </button>
    </div>

    
    <form method="post" action="{% url 'accounts:event_edit' event.id %}" class="space-y-4">
      {% csrf_token %}

      
      <div>
        <label for="id_title_{{ event.id }}" class="block text-sm font-medium text-gray-700">Event Title</label>
        <input type="text" name="title" id="id_title_{{ event.id }}" value="{{ event.title }}"
          class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="Enter event title" required>
      </div>

      
      <div>
        <label for="id_description_{{ event.id }}" class="block text-sm font-medium text-gray-700">Description</label>
        <textarea name="description" id="id_description_{{ event.id }}" rows="3"
          class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="Brief event description">{{ event.description }}</textarea>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="id_start_datetime_{{ event.id }}" class="block text-sm font-medium text-gray-700">Start Date & Time</label>
          <input type="datetime-local" name="start_datetime" id="id_start_datetime_{{ event.id }}"
            value="{{ event.start_datetime|date:'Y-m-d\\TH:i' }}"
            class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
        </div>
        <div>
          <label for="id_end_datetime_{{ event.id }}" class="block text-sm font-medium text-gray-700">End Date & Time</label>
          <input type="datetime-local" name="end_datetime" id="id_end_datetime_{{ event.id }}"
            value="{{ event.end_datetime|date:'Y-m-d\\TH:i' }}"
            class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
        </div>
      </div>

      <div>
        <label for="id_location_{{ event.id }}" class="block text-sm font-medium text-gray-700">Location</label>
        <input type="text" name="location" id="id_location_{{ event.id }}" value="{{ event.location }}"
          class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="Ex. 4th Floor Hall, Main Building" required>
      </div>

      
      <div>
        <label for="id_total_slots_{{ event.id }}" class="block text-sm font-medium text-gray-700">Total Slots</label>
        <input type="number" name="total_slots" id="id_total_slots_{{ event.id }}" value="{{ event.total_slots }}" min="1"
          class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="Enter number of slots" required>
      </div>

      
      <div class="mt-6 flex justify-end gap-2">
        <button type="button" onclick="closeModal('modalEdit{{ event.id }}')"
          class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg">Cancel</button>
        <button type="submit"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-sm">Save Changes</button>
      </div>
    </form>
  </div>
</div>


   
    <div id="modalDelete{{ event.id }}" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
        <h3 class="text-xl font-semibold mb-4">Delete Event</h3>
        <p>Are you sure you want to delete <strong>{{ event.title }}</strong>?</p>
        <form method="post" action="{% url 'accounts:event_delete' event.id %}" class="mt-4 flex justify-end gap-2">
          {% csrf_token %}
          <button type="button" onclick="closeModal('modalDelete{{ event.id }}')" class="px-4 py-2 bg-gray-100 rounded">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
        </form>
      </div>
    </div>
    {% endif %}

    {% if user.member.role not in "admin superadmin" %}
    
    <div id="modalRegister{{ event.id }}" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
        <h3 class="text-xl font-semibold mb-4">Register for Event</h3>
        <p>Are you sure you want to register for <strong>{{ event.title }}</strong>?</p>
        <form method="post" action="{% url 'accounts:register_event' event.id %}" class="mt-4 flex justify-end gap-2">
          {% csrf_token %}
          <button type="button" onclick="closeModal('modalRegister{{ event.id }}')" class="px-4 py-2 bg-gray-100 rounded">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Register</button>
        </form>
      </div>
    </div>

    
    <div id="modalCancel{{ event.id }}" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
        <h3 class="text-xl font-semibold mb-4">Cancel Registration</h3>
        <p>Are you sure you want to cancel your registration for <strong>{{ event.title }}</strong>?</p>
        <form method="post" action="{% url 'accounts:cancel_event' event.id %}" class="mt-4 flex justify-end gap-2">
          {% csrf_token %}
          <button type="button" onclick="closeModal('modalCancel{{ event.id }}')" class="px-4 py-2 bg-gray-100 rounded">Keep</button>
          <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded">Cancel Registration</button>
        </form>
      </div>
    </div>
    {% endif %}
    {% endfor %}
  </div>
</div>
{% if user.member.role == "admin" or user.member.role == "superadmin" %}

<div id="modalCreate" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 relative">

    
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-2xl font-semibold text-gray-800">Create Event</h3>
      <button type="button" onclick="closeModal('modalCreate')" class="text-gray-500 hover:text-gray-700">✕</button>
    </div>

    
    <form id="createEventForm" method="post" action="{% url 'accounts:event_create' %}" class="space-y-4">
      {% csrf_token %}

     
      <div>
        <label for="id_title" class="block text-sm font-medium text-gray-700">Event Title</label>
        <input type="text" name="title" id="id_title" class="mt-1 w-full rounded-lg border-gray-300" required>
        <div class="error-message text-red-500 text-sm mt-1" data-error-for="title"></div>
      </div>

      
      <div>
        <label for="id_description" class="block text-sm font-medium text-gray-700">Description</label>
        <textarea name="description" id="id_description" rows="3" class="mt-1 w-full rounded-lg border-gray-300"></textarea>
        <div class="error-message text-red-500 text-sm mt-1" data-error-for="description"></div>
      </div>

     
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="id_start_datetime" class="block text-sm font-medium text-gray-700">Start Date & Time</label>
          <input type="datetime-local" name="start_datetime" id="id_start_datetime" class="mt-1 w-full rounded-lg border-gray-300" required>
          <div class="error-message text-red-500 text-sm mt-1" data-error-for="start_datetime"></div>
        </div>
        <div>
          <label for="id_end_datetime" class="block text-sm font-medium text-gray-700">End Date & Time</label>
          <input type="datetime-local" name="end_datetime" id="id_end_datetime" class="mt-1 w-full rounded-lg border-gray-300" required>
          <div class="error-message text-red-500 text-sm mt-1" data-error-for="end_datetime"></div>
        </div>
      </div>

      
      <div>
        <label for="id_location" class="block text-sm font-medium text-gray-700">Location</label>
        <input type="text" name="location" id="id_location" class="mt-1 w-full rounded-lg border-gray-300" required>
        <div class="error-message text-red-500 text-sm mt-1" data-error-for="location"></div>
      </div>

      
      <div>
        <label for="id_max_slots" class="block text-sm font-medium text-gray-700">Total Slots</label>
        <input type="number" name="max_slots" id="id_max_slots" min="1"  value="{{ form.max_slots.value }}" class="mt-1 w-full rounded-lg border-gray-300" required>
        <div class="error-message text-red-500 text-sm mt-1" data-error-for="max_slots"></div>
      </div>

      
      <div class="mt-6 flex justify-end gap-2">
        <button type="button" onclick="closeModal('modalCreate')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg">Create</button>
      </div>
    </form>
  </div>
</div>
{% endif %}
{% block scripts %}
<script src="{% static 'accounts/js/event_list.js' %}"></script>
{% endblock %}
{% endblock %}