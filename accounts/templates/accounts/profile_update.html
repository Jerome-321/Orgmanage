{% extends "accounts/base.html" %}
{% load static %}
{% block content %}
<div class="max-w-7xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-2">My Profile</h1>
  <p class="text-gray-600 mb-6">Manage your personal information and achievements</p>

  <!-- ===== Top Section ===== -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Personal Info Card -->
    <div class="bg-white p-6 rounded-2xl shadow col-span-2">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Personal Information</h2>
        <button id="editBtn" type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Edit Profile</button>
      </div>

      <form id="profileForm" method="post">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Full Name -->
          <label class="block">
            <span class="text-sm text-gray-700">Full Name</span>
            <input type="text" name="full_name" value="{{ member.user.get_full_name }}" class="mt-1 block w-full px-3 py-2 border rounded" readonly />
          </label>

          <!-- Email -->
          <label class="block">
            <span class="text-sm text-gray-700">Email Address</span>
            <input type="email" name="email" value="{{ member.user.email }}" class="mt-1 block w-full px-3 py-2 border rounded" readonly />
          </label>

          <!-- Student ID -->
          <label class="block">
            <span class="text-sm text-gray-700">Student ID</span>
            <input type="text" name="student_id" value="{{ member.student_id }}" class="mt-1 block w-full px-3 py-2 border rounded" readonly />
          </label>

          <!-- Course -->
          <label class="block">
            <span class="text-sm text-gray-700">Course</span>
            <input type="text" name="course" value="{{ member.course }}" class="mt-1 block w-full px-3 py-2 border rounded" readonly />
          </label>

          <!-- Year of Study -->
          <label class="block">
            <span class="text-sm text-gray-700">Year of Study</span>
            <input type="text" name="year" value="{{ member.year }}" class="mt-1 block w-full px-3 py-2 border rounded" readonly />
          </label>

          <!-- Membership Status -->
          <label class="block">
            <span class="text-sm text-gray-700">Membership Status</span>
            <input type="text" name="status" value="{{ member.status }}" class="mt-1 block w-full px-3 py-2 border rounded" readonly />
          </label>
        </div>

        <!-- Save/Cancel Actions -->
        <div id="editActions" class="hidden mt-4 flex gap-2">
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
          <button type="button" id="cancelEdit" class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Profile Summary Card -->
    <div class="bg-white p-6 rounded-2xl shadow flex flex-col items-center text-center">
      <div class="w-20 h-20 rounded-full bg-gray-200 flex items-center justify-center mb-3">
        <svg class="w-10 h-10 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 10a4 4 0 100-8 4 4 0 000 8zM2 18a8 8 0 1116 0H2z" />
        </svg>
      </div>
      <h3 class="text-lg font-semibold">{{ member.user.get_full_name }}</h3>
      <p class="text-gray-500">{{ member.student_id }}</p>
      {% if user.is_superuser %}
        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-600 border border-blue-200">superadmin</span>
      {% elif user.member.role == "Admin" %}
        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-600 border border-green-200">admin</span>
      {% else %}
        <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600 border border-gray-200">member</span>
      {% endif %}
      <p class="mt-2">Status: <span class="px-2 py-1 bg-green-100 text-green-600 text-xs rounded">active</span></p>
      <p class="mt-2 text-sm text-gray-500">Member Since: {{ user.date_joined|date:"d/m/Y" }}</p>
      <p class="text-sm text-gray-500">Achievements: {{ achievements.count }}</p>
    </div>
  </div>

  <!-- ===== Achievements Section ===== -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
    <div class="bg-white p-6 rounded-2xl shadow col-span-2">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Achievements & Certifications</h2>
        <button type="button" id="addAchievementBtn" class="px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">+ Add Achievement</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {% for achievement in achievements %}
        <div class="p-4 border rounded-lg shadow-sm relative group">
          <h3 class="font-semibold">{{ achievement.title }}</h3>
          <p class="text-gray-600 text-sm">{{ achievement.description }}</p>
          <p class="text-xs text-gray-400 mt-1">Earned: {{ achievement.date_earned|date:"d/m/Y" }}</p>

          {% if achievement.certificate %}
          <a href="{% url 'accounts:view_achievement' achievement.id %}" 
   target="_blank"
   class="text-blue-600 text-sm mt-2 inline-block hover:underline">
   📄 View Certificate
</a>

          {% endif %}

          <!-- Delete Achievement -->
          <form method="post" action="{% url 'accounts:delete_achievement' achievement.id %}" class="absolute top-2 right-2 hidden group-hover:block" onsubmit="return confirm('Are you sure you want to delete this achievement?');">
            {% csrf_token %}
            <button type="submit" class="text-red-500 hover:text-red-700 text-sm font-semibold">✕</button>
          </form>
        </div>
        {% empty %}
        <p class="text-gray-500">No achievements yet.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- ===== Add Achievement Modal ===== -->
  <div id="addAchievementModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-lg transform scale-95 transition-all">
      <h2 class="text-lg font-semibold mb-4">Add Achievement</h2>
      <form method="post" action="{% url 'accounts:add_achievement' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
          <label class="block text-sm text-gray-700">Title</label>
          <input type="text" name="title" class="w-full border rounded px-3 py-2" required>
        </div>
        <div class="mb-3">
          <label class="block text-sm text-gray-700">Description</label>
          <textarea name="description" class="w-full border rounded px-3 py-2" rows="3" required></textarea>
        </div>
        <div class="mb-3">
          <label class="block text-sm text-gray-700">Date Earned</label>
          <input type="date" name="date_earned" class="w-full border rounded px-3 py-2" required>
        </div>
        <div class="mb-3">
          <label class="block text-sm text-gray-700">Upload Certificate</label>
          <input type="file" name="certificate" accept=".jpg,.jpeg,.png,.pdf" class="w-full border rounded px-3 py-2 cursor-pointer bg-gray-50">
          <p class="text-xs text-gray-500 mt-1">Accepted formats: JPG, PNG, or PDF (max 5MB)</p>
        </div>
        <div class="flex justify-end space-x-2">
  <button type="button" onclick="closeAddAchievementModal()" 
    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
    Cancel
  </button>
  <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
    Add
  </button>
</div>

      </form>
    </div>
  </div>
  <!-- 📜 View Certificate Modal -->
<div id="certificateModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70">
  <div class="relative bg-white rounded-2xl shadow-lg p-4 w-11/12 max-w-3xl transform scale-95 transition-all">
    
    <!-- ❌ Close Button -->
    <button type="button" onclick="closeCertificateModal()" class="absolute top-2 right-3 text-gray-600 hover:text-gray-900 text-2xl font-bold">
      &times;
    </button>

    <!-- Certificate Content -->
    <div id="certificateContent" class="mt-6 flex justify-center">
      <!-- PDF/Image will load here dynamically -->
    </div>

    <!-- 🗑️ Delete Button -->
    <div class="mt-4 flex justify-end">
      <form id="deleteAchievementForm" method="POST" action="">
        {% csrf_token %}
        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Delete</button>
      </form>
    </div>
  </div>
</div>
</div>

{% block scripts %}
<script src="{% static 'accounts/js/add_achievement.js' %}"></script>
<script src="{% static 'accounts/js/achievement.js' %}"></script>
<script src="{% static 'accounts/js/profile.js' %}"></script>
{% endblock %}
{% endblock %}
